<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <!-- –í–ê–ñ–õ–ò–í–û: viewport-fit=cover –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤–µ—Å—å –ø—Ä–æ—Å—Ç—ñ—Ä –µ–∫—Ä–∞–Ω—É -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HappyFoot Admin</title>
    
    <!-- PWA Settings (–¥–ª—è –≤–∏–≥–ª—è–¥—É —è–∫ –¥–æ–¥–∞—Ç–æ–∫) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff"> 
    
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ —Ç–∞ —ñ–∫–æ–Ω–æ–∫ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –±–µ–∑–ø–µ—á–Ω–∏—Ö –∑–æ–Ω (—á—É–±—á–∏–∫, –Ω–∏–∂–Ω—è —Å–º—É–≥–∞) */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
            /* –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ —Å–∫—Ä–æ–ª—É –≤—Å—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏, —Å–∫—Ä–æ–ª–∏–º–æ —Ç—ñ–ª—å–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç */
            height: 100vh;
            height: 100dvh;
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }

        .bg-brand { background-color: #04273b; }
        .text-brand { color: #04273b; }
        
        /* –ï–∫—Ä–∞–Ω–∏ */
        .screen { 
            display: none; 
            width: 100%; 
            height: 100%; 
            flex-direction: column;
            position: absolute; /* –§—ñ–∫—Å—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—é */
            top: 0;
            left: 0;
            z-index: 10;
            background-color: #f8fafc; /* –§–æ–Ω –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        }
        
        /* –ö–ª–∞—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É */
        .screen.active { 
            display: flex !important; 
            z-index: 20;
        }

        /* –ï–∫—Ä–∞–Ω –≤—Ö–æ–¥—É –º–∞—î —Å–≤—ñ–π —Ñ–æ–Ω —ñ –≤–∏—â–∏–π z-index */
        #login-screen {
            z-index: 50;
            background-color: #04273b;
        }
        
        .tab-content { display: none; animation: fadeIn 0.2s ease; flex: 1; width: 100%; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* --- –ê–î–ê–ü–¢–ê–¶–Ü–Ø –ü–Ü–î FULLSCREEN --- */
        
        /* –®–∞–ø–∫–∞ –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É —Ä—ñ–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä—É "—á—É–±—á–∏–∫–∞" */
        header {
            padding-top: calc(1rem + var(--safe-top)) !important;
            padding-bottom: 1rem;
        }
        
        /* –ù–∏–∂–Ω—î –º–µ–Ω—é –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ—ó —Å–º—É–≥–∏ */
        .bottom-nav {
            padding-bottom: calc(0.5rem + var(--safe-bottom)) !important;
            height: auto;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –º–∞—î –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É, —â–æ–± –Ω–µ —Ö–æ–≤–∞—Ç–∏—Å—è –∑–∞ –º–µ–Ω—é */
        .safe-bottom { 
            padding-bottom: calc(100px + var(--safe-bottom)) !important; 
        }

        /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è —Å–∫—Ä–æ–ª–±–∞—Ä—É */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>

    <!-- === 1. –ï–ö–†–ê–ù –í–•–û–î–£ === -->
    <div id="login-screen" class="screen active items-center justify-center p-6 text-white">
        <div class="flex flex-col items-center w-full max-w-sm">
            <div class="mb-12 text-center">
                <div class="text-5xl font-extrabold mb-2 tracking-tight">Happy<span class="text-sky-400">Foot</span></div>
                <div class="text-[10px] opacity-50 tracking-[0.5em] uppercase font-bold">Admin Control</div>
            </div>
            <div class="w-full bg-white/5 backdrop-blur-xl p-8 rounded-3xl border border-white/10 shadow-2xl">
                <input type="password" id="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric"
                       class="w-full bg-slate-900/50 text-white text-center text-4xl tracking-[0.5em] p-4 rounded-2xl border border-white/10 mb-6 focus:border-sky-400 focus:ring-4 outline-none transition-all">
                <button id="login-btn" class="w-full bg-white text-brand font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">–£–í–Ü–ô–¢–ò</button>
            </div>
        </div>
    </div>

    <!-- === 2. –ì–û–õ–û–í–ù–ê –ü–ê–ù–ï–õ–¨ (DASHBOARD) === -->
    <div id="dashboard-screen" class="screen bg-slate-50">
        
        <!-- –®–∞–ø–∫–∞ –∑ –¥–∞—Ç–æ—é —ñ –∫–Ω–æ–ø–∫–æ—é –≤–∏—Ö–æ–¥—É -->
        <header class="bg-white px-5 shadow-sm flex justify-between items-center z-20 border-b border-slate-100 shrink-0 transition-all">
            <div>
                <h1 class="font-bold text-xl text-brand flex items-center gap-2">HappyFoot <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span></h1>
                <p class="text-xs text-slate-400 font-medium" id="current-date">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
            <button onclick="location.reload()" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-red-500 transition">
                <span class="material-icons-round" style="font-size: 20px;">logout</span>
            </button>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–∞ –∑–æ–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç—É -->
        <div class="flex-1 overflow-y-auto p-4 safe-bottom scroll-smooth w-full relative">
            
            <!-- –í–ö–õ–ê–î–ö–ê 1: –†–û–ó–ö–õ–ê–î (–ó–ê–ü–ò–°–ò) -->
            <div id="tab-active" class="tab-content active space-y-3">
                <div id="list-active" class="space-y-3 w-full">
                    <div class="text-center text-slate-400 py-10">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤...</div>
                </div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê 2: –ö–û–ú–ê–ù–î–ê -->
            <div id="tab-team" class="tab-content space-y-4">
                <h2 class="text-lg font-bold text-brand px-1">–ö–æ–º–∞–Ω–¥–∞ —Ç–∞ –ì—Ä–∞—Ñ—ñ–∫</h2>
                <div id="team-list" class="space-y-3"></div>
                <button onclick="openTeamModal()" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-sm flex items-center justify-center gap-2 hover:bg-slate-50 transition active:scale-95">
                    <span class="material-icons-round">person_add</span> –î–û–î–ê–¢–ò –ü–†–ê–¶–Ü–í–ù–ò–ö–ê
                </button>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê 3: –ü–û–°–õ–£–ì–ò -->
            <div id="tab-services" class="tab-content space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h2 class="text-lg font-bold text-brand">–†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ—Å–ª—É–≥</h2>
                </div>
                <div id="services-list" class="space-y-3"></div>
                <button onclick="openServiceModal('new-category')" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-sm flex items-center justify-center gap-2 hover:bg-slate-50 transition active:scale-95">
                    <span class="material-icons-round">add_circle_outline</span> –î–û–î–ê–¢–ò –ö–ê–¢–ï–ì–û–†–Ü–Æ
                </button>
            </div>

        </div>

        <!-- –ù–∏–∂–Ω—î –º–µ–Ω—é –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó -->
        <div class="bottom-nav bg-white/95 backdrop-blur-lg border-t border-slate-200 p-2 flex justify-around items-center z-20 fixed bottom-0 w-full shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
            <button onclick="switchTab('active')" id="btn-tab-active" class="nav-btn text-brand bg-blue-50/50 flex flex-col items-center p-2 w-1/3 rounded-xl transition-all"><span class="material-icons-round">event_note</span><span class="text-[10px] font-bold mt-1">–†–û–ó–ö–õ–ê–î</span></button>
            <button onclick="switchTab('team')" id="btn-tab-team" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-1/3 rounded-xl transition-all"><span class="material-icons-round">groups</span><span class="text-[10px] font-bold mt-1">–ö–û–ú–ê–ù–î–ê</span></button>
            <button onclick="switchTab('services')" id="btn-tab-services" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-1/3 rounded-xl transition-all"><span class="material-icons-round">edit_note</span><span class="text-[10px] font-bold mt-1">–ü–û–°–õ–£–ì–ò</span></button>
        </div>
    </div>

    <!-- === –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û: –î–ï–¢–ê–õ–Ü –ó–ê–ü–ò–°–£ === -->
    <div id="details-modal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0" onclick="closeDetails()"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 pb-safe-area shadow-2xl modal-enter relative z-10">
            <button onclick="closeDetails()" class="absolute top-4 right-4 p-2 bg-slate-50 rounded-full text-slate-400 hover:bg-slate-100"><span class="material-icons-round">close</span></button>
            
            <div class="text-center mb-6 pt-2">
                <h3 class="text-2xl font-bold text-slate-800 mb-1" id="modal-name">–Ü–º'—è</h3>
                <a href="#" id="modal-phone-link" class="text-sky-600 font-bold text-lg inline-flex items-center gap-2 bg-sky-50 px-4 py-1 rounded-full"><span class="material-icons-round text-base">phone</span> <span id="modal-phone">...</span></a>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-2xl mb-4 text-center border border-slate-100">
                <div class="text-xs text-slate-400 font-bold uppercase mb-1">–ü—Ä–æ—Ü–µ–¥—É—Ä–∞</div>
                <div class="font-bold text-brand text-lg leading-tight" id="modal-service">–ü–æ—Å–ª—É–≥–∞</div>
                <div class="text-sm text-slate-500 flex justify-center items-center gap-1 mt-2 border-t border-slate-200 pt-2"><span class="material-icons-round text-sm">person</span> <span id="modal-specialist">–°–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç</span></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100"><span class="text-[10px] text-slate-400 font-bold uppercase block mb-1">–î–∞—Ç–∞</span><div class="text-lg font-bold text-brand" id="display-date">--.--</div></div>
                <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100"><span class="text-[10px] text-slate-400 font-bold uppercase block mb-1">–ß–∞—Å</span><div class="text-2xl font-extrabold text-brand" id="display-time">--:--</div></div>
            </div>

            <div class="space-y-3 mb-4">
                <button id="btn-confirm" onclick="askConfirm()" class="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-green-600/20 active:scale-95 transition-transform">–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò –ó–ê–ü–ò–° ‚úÖ</button>
                <button onclick="askDelete()" class="w-full text-red-500 py-3 bg-red-50 rounded-xl text-xs font-bold border border-red-100 active:scale-95 transition-transform">–°–∫–∞—Å—É–≤–∞—Ç–∏ / –í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
            <input type="hidden" id="current-id">
        </div>
    </div>

    <!-- === –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û: –†–ï–î–ê–ö–¢–û–† –ö–û–ú–ê–ù–î–ò === -->
    <div id="team-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0" onclick="closeTeamModal()"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-enter relative z-10 max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6 pt-2">
                <h3 class="text-xl font-bold text-brand" id="team-modal-title">–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫</h3>
                <button onclick="closeTeamModal()" class="p-1 bg-slate-100 rounded-full text-slate-400"><span class="material-icons-round">close</span></button>
            </div>
            <div class="space-y-4 mb-6">
                <input type="hidden" id="team-id">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">–Ü–º'—è</label>
                    <input type="text" id="team-name" placeholder="–Ω–∞–ø—Ä. –û–ª—å–≥–∞" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold text-brand">
                </div>
                <div>
                     <label class="text-xs font-bold text-slate-400 uppercase ml-1">–ü–æ—Å–∞–¥–∞</label>
                    <input type="text" id="team-role" placeholder="–Ω–∞–ø—Ä. –ü–æ–¥–æ–ª–æ–≥" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500">
                </div>
                
                <div class="border-t border-slate-100 pt-4">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">–í–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–±–æ—á—ñ –≥–æ–¥–∏–Ω–∏:</label>
                    <div class="grid grid-cols-4 gap-2" id="team-hours-grid">
                        <!-- JS generated -->
                    </div>
                </div>

                <button onclick="saveTeamMember()" class="w-full bg-brand text-white py-4 rounded-xl font-bold shadow-lg mt-2 active:scale-95 transition-transform">–ó–ë–ï–†–ï–ì–¢–ò</button>
                <button id="btn-delete-team" onclick="deleteTeamMember()" class="w-full text-red-500 py-3 bg-red-50 rounded-xl text-xs font-bold border border-red-100 hidden">–ó–≤—ñ–ª—å–Ω–∏—Ç–∏ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞</button>
            </div>
        </div>
    </div>
    
    <!-- === –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û: –†–ï–î–ê–ö–¢–û–† –ü–û–°–õ–£–ì === -->
    <div id="service-editor-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0" onclick="document.getElementById('service-editor-modal').classList.add('hidden')"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-enter relative z-10 max-h-[90vh] flex flex-col">
            <!-- Content generated by JS -->
            <div id="service-modal-content" class="flex flex-col h-full"></div>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, orderBy, query, deleteDoc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBzjaoG4jyD1pjBH9Z0XhL6ZzAp_WT4Ep4",
            authDomain: "happyfoot-lviv.firebaseapp.com",
            projectId: "happyfoot-lviv",
            storageBucket: "happyfoot-lviv.firebasestorage.app",
            messagingSenderId: "825936740538",
            appId: "1:825936740538:web:7aa5fa34a1a5f020f04283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* --- STATE --- */
        let servicesData = {};
        let currentAppointments = [];
        let specialistsData = [];

        // –§—É–Ω–∫—Ü—ñ—è –≤—Ö–æ–¥—É (PIN 1111)
        window.checkPin = function() {
            const pin = document.getElementById('pin-input').value;
            if(pin === '1111') {
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –µ–∫—Ä–∞–Ω –≤—Ö–æ–¥—É (–∂–æ—Ä—Å—Ç–∫–æ)
                const loginScreen = document.getElementById('login-screen');
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.remove('active');
                    loginScreen.style.display = 'none';
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ –¥–µ—à–±–æ—Ä–¥
                    const dashboard = document.getElementById('dashboard-screen');
                    dashboard.style.display = 'flex'; // –°–ø–æ—á–∞—Ç–∫—É display: flex
                    setTimeout(() => {
                        dashboard.classList.add('active'); // –ü–æ—Ç—ñ–º –∫–ª–∞—Å active –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ–π —è–∫—â–æ —î
                        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –¥–∞–Ω—ñ
                        initApp();
                    }, 50);
                }, 200); // –ö–æ—Ä–æ—Ç–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è
            } else { 
                alert('–ù–µ–≤—ñ—Ä–Ω–∏–π PIN! –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.'); 
                document.getElementById('pin-input').value = ''; 
            }
        }
        
        // –î–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á –ø–æ–¥—ñ–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥—É
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('login-btn');
            if(loginBtn) {
                loginBtn.addEventListener('click', window.checkPin);
            }
            
            // –¢–∞–∫–æ–∂ —Å–ª—É—Ö–∞—î–º–æ Enter –Ω–∞ –ø–æ–ª—ñ –≤–≤–æ–¥—É
            const pinInput = document.getElementById('pin-input');
            if(pinInput) {
                pinInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        window.checkPin();
                    }
                });
            }
        });

        function initApp() {
            console.log("Initializing App...");
            setupAppointments();
            setupTeam();
            setupServices();
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const dateEl = document.getElementById('current-date');
            if(dateEl) dateEl.innerText = new Date().toLocaleDateString('uk-UA', options);
            
            renderHoursGrid();
        }

        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
        window.switchTab = function(tabName) {
            // –•–æ–≤–∞—î–º–æ –≤—Å—ñ
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É
            const targetTab = document.getElementById(`tab-${tabName}`);
            if(targetTab) targetTab.classList.add('active');
            
            // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = "nav-btn text-slate-400 flex flex-col items-center p-2 w-1/3 rounded-xl transition-all hover:bg-slate-50";
            });
            // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É
            const targetBtn = document.getElementById(`btn-tab-${tabName}`);
            if(targetBtn) targetBtn.className = "nav-btn text-brand bg-blue-50/50 flex flex-col items-center p-2 w-1/3 rounded-xl transition-all";
        }

        /* === –õ–û–ì–Ü–ö–ê –ó–ê–ü–ò–°–Ü–í (–†–û–ó–ö–õ–ê–î) === */
        function setupAppointments() {
            const q = query(collection(db, "appointments"), orderBy("date", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('list-active');
                if(!list) return;
                list.innerHTML = ''; 
                currentAppointments = [];

                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-slate-400 py-10 flex flex-col items-center"><span class="material-icons-round text-4xl mb-2 opacity-20">event_busy</span>–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    currentAppointments.push({ id, ...data });

                    const el = document.createElement('div');
                    
                    let statusClass = data.status === 'confirmed' ? 'border-green-500' : 'border-[#04273b]';
                    let statusBg = data.status === 'confirmed' ? 'bg-green-50' : 'bg-white';
                    let badge = data.status === 'confirmed' 
                        ? '<span class="bg-green-100 text-green-800 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><span class="material-icons-round text-[10px]">check</span> OK</span>' 
                        : '<span class="bg-sky-100 text-sky-800 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><span class="material-icons-round text-[10px]">schedule</span> NEW</span>';
                    
                    el.className = `p-4 rounded-xl shadow-sm border-l-[6px] ${statusClass} ${statusBg} mb-3 cursor-pointer active:scale-95 transition-transform relative overflow-hidden`;
                    el.onclick = () => openDetails(id);
                    
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white border border-slate-100 flex items-center justify-center font-bold text-slate-500 text-lg shadow-sm">${data.name ? data.name[0].toUpperCase() : '?'}</div>
                                <div>
                                    <h4 class="font-bold text-slate-800 leading-none text-base">${data.name || '–ö–ª—ñ—î–Ω—Ç'}</h4>
                                    <div class="text-xs text-slate-500 mt-1 font-mono bg-slate-100 px-2 py-0.5 rounded inline-block">üìÖ ${data.date} ‚Ä¢ ${data.time}</div>
                                </div>
                            </div>
                            ${badge}
                        </div>
                        <div class="bg-white/50 border border-slate-100 p-2 rounded-lg text-xs text-slate-600 flex justify-between items-center">
                            <span class="font-bold text-brand truncate max-w-[120px]">üíÖ ${data.serviceName || '–ü–æ—Å–ª—É–≥–∞'}</span>
                            <span class="flex items-center gap-1 text-slate-400"><span class="material-icons-round text-[12px]">person</span> ${data.specialistName || '–ë—É–¥—å-—Ö—Ç–æ'}</span>
                        </div>
                    `;
                    list.appendChild(el);
                });
            });
        }

        window.openDetails = (id) => {
            const data = currentAppointments.find(a => a.id === id);
            if(!data) return;
            
            document.getElementById('current-id').value = id;
            document.getElementById('modal-name').innerText = data.name;
            document.getElementById('modal-phone').innerText = data.phone;
            document.getElementById('modal-phone-link').href = `tel:${data.phone}`;
            document.getElementById('display-date').innerText = data.date;
            document.getElementById('display-time').innerText = data.time;
            document.getElementById('modal-service').innerText = data.serviceName || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
            document.getElementById('modal-specialist').innerText = data.specialistName || '–ë—É–¥—å-—Ö—Ç–æ';
            
            const btnConfirm = document.getElementById('btn-confirm');
            if(data.status === 'confirmed') {
                btnConfirm.classList.add('hidden');
            } else {
                btnConfirm.classList.remove('hidden');
            }

            document.getElementById('details-modal').classList.remove('hidden');
        }

        window.closeDetails = () => document.getElementById('details-modal').classList.add('hidden');
        
        window.askConfirm = async () => {
             const id = document.getElementById('current-id').value;
             await updateDoc(doc(db, "appointments", id), { status: 'confirmed' });
             if(navigator.vibrate) navigator.vibrate(50);
             closeDetails();
        }
        
        window.askDelete = async () => {
             if(confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')) {
                 await deleteDoc(doc(db, "appointments", document.getElementById('current-id').value));
                 closeDetails();
             }
        }

        /* === –õ–û–ì–Ü–ö–ê –ö–û–ú–ê–ù–î–ò === */
        const ALL_HOURS = ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00"];
        
        function renderHoursGrid() {
            const grid = document.getElementById('team-hours-grid');
            if(!grid) return;
            grid.innerHTML = '';
            ALL_HOURS.forEach(h => {
                const label = document.createElement('label');
                label.className = "flex items-center justify-center p-2 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 select-none text-xs font-bold transition-colors";
                label.innerHTML = `<input type="checkbox" value="${h}" class="hidden peer"> <span class="peer-checked:text-sky-600">${h}</span>`;
                
                label.querySelector('input').addEventListener('change', (e) => {
                    if(e.target.checked) {
                        label.classList.add('bg-sky-50', 'border-sky-300', 'ring-1', 'ring-sky-300');
                    } else {
                        label.classList.remove('bg-sky-50', 'border-sky-300', 'ring-1', 'ring-sky-300');
                    }
                });
                grid.appendChild(label);
            });
        }

        function setupTeam() {
            onSnapshot(collection(db, "specialists"), (snap) => {
                const list = document.getElementById('team-list');
                if(!list) return;
                list.innerHTML = '';
                specialistsData = [];
                snap.forEach(d => {
                    const data = d.data();
                    specialistsData.push({id: d.id, ...data});
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm";
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-sky-100 to-white rounded-full flex items-center justify-center font-bold text-brand text-lg shadow-inner border border-slate-100">${data.name ? data.name[0] : '?'}</div>
                            <div>
                                <div class="font-bold text-brand text-lg">${data.name}</div>
                                <div class="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-0.5 rounded inline-block mt-0.5">${data.role}</div>
                            </div>
                        </div>
                        <button onclick="editTeam('${d.id}')" class="text-sky-600 font-bold text-xs bg-sky-50 px-4 py-2 rounded-lg hover:bg-sky-100 transition">–†–ï–î–ê–ì–£–í–ê–¢–ò</button>
                    `;
                    list.appendChild(el);
                });
            });
        }

        window.openTeamModal = () => {
            document.getElementById('team-id').value = '';
            document.getElementById('team-name').value = '';
            document.getElementById('team-role').value = '';
            document.querySelectorAll('#team-hours-grid input').forEach(i => { 
                i.checked = true; 
                i.dispatchEvent(new Event('change')); 
            }); 
            document.getElementById('btn-delete-team').classList.add('hidden');
            document.getElementById('team-modal-title').innerText = "–ù–æ–≤–∏–π –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫";
            document.getElementById('team-modal').classList.remove('hidden');
        }

        window.editTeam = (id) => {
            const spec = specialistsData.find(s => s.id === id);
            document.getElementById('team-id').value = id;
            document.getElementById('team-name').value = spec.name;
            document.getElementById('team-role').value = spec.role;
            document.getElementById('team-modal-title').innerText = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è";
            
            document.querySelectorAll('#team-hours-grid input').forEach(i => { 
                i.checked = (spec.hours || []).includes(i.value);
                i.dispatchEvent(new Event('change'));
            });
            document.getElementById('btn-delete-team').classList.remove('hidden');
            document.getElementById('team-modal').classList.remove('hidden');
        }

        window.closeTeamModal = () => document.getElementById('team-modal').classList.add('hidden');

        window.saveTeamMember = async () => {
            const id = document.getElementById('team-id').value;
            const name = document.getElementById('team-name').value;
            const role = document.getElementById('team-role').value;
            const hours = Array.from(document.querySelectorAll('#team-hours-grid input:checked')).map(i => i.value);

            if(!name) return alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º\'—è');

            if(id) {
                await updateDoc(doc(db, "specialists", id), { name, role, hours });
            } else {
                await addDoc(collection(db, "specialists"), { name, role, hours });
            }
            closeTeamModal();
        }

        window.deleteTeamMember = async () => {
            if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ –∑ –±–∞–∑–∏?')) {
                await deleteDoc(doc(db, "specialists", document.getElementById('team-id').value));
                closeTeamModal();
            }
        }

        /* === –õ–û–ì–Ü–ö–ê –ü–û–°–õ–£–ì === */
        function setupServices() {
            const list = document.getElementById('services-list');
            if(!list) return;
            onSnapshot(collection(db, "services"), (snap) => {
                list.innerHTML = '';
                servicesData = {}; 
                snap.forEach(d => {
                     const data = d.data();
                     servicesData[d.id] = data; 
                     
                     const el = document.createElement('div');
                     el.className = "bg-white p-4 rounded-xl border border-slate-200 mb-2 flex justify-between items-center shadow-sm";
                     el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-2xl bg-slate-50 w-12 h-12 rounded-xl flex items-center justify-center">${data.icon||'‚ú®'}</div>
                            <div>
                                <div class="font-bold text-brand text-lg">${data.title}</div>
                                <div class="text-xs text-slate-400 mt-0.5 font-medium">${(data.items||[]).length} –ø–æ—Å–ª—É–≥ –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</div>
                            </div>
                        </div>
                        <button onclick="openServiceModal('${d.id}')" class="text-sky-600 font-bold text-xs bg-sky-50 px-4 py-2 rounded-lg hover:bg-sky-100 transition">–ó–ú–Ü–ù–ò–¢–ò</button>
                     `;
                     list.appendChild(el);
                });
            });
        }

        let currentServiceId = null;

        window.openServiceModal = (id) => {
            const isNew = id === 'new-category';
            currentServiceId = isNew ? null : id;
            const data = isNew ? { title: '', icon: '‚ú®', items: [] } : servicesData[id];

            const modalContent = document.getElementById('service-modal-content');
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 pt-2 shrink-0">
                    <h3 class="text-xl font-bold text-brand">${isNew ? '–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è' : '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó'}</h3>
                    <button onclick="document.getElementById('service-editor-modal').classList.add('hidden')" class="p-1 bg-slate-100 rounded-full text-slate-400"><span class="material-icons-round">close</span></button>
                </div>
                <div class="space-y-4 overflow-y-auto flex-1 pr-1 pb-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                        <input type="text" id="srv-title" value="${data.title}" placeholder="–Ω–∞–ø—Ä. –ú–∞—Å–∞–∂" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold outline-none focus:border-sky-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">–Ü–∫–æ–Ω–∫–∞ (—Å–º–∞–π–ª–∏–∫)</label>
                        <input type="text" id="srv-icon" value="${data.icon}" placeholder="emoji" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500">
                    </div>
                    
                    <div class="border-t border-slate-100 pt-4">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-3 block flex justify-between items-center">
                            –°–ø–∏—Å–æ–∫ –ø–æ—Å–ª—É–≥:
                            <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500" id="item-count">${(data.items||[]).length} —à—Ç</span>
                        </label>
                        <div id="srv-items-list" class="space-y-3"></div>
                        <button onclick="addServiceItemInput()" class="w-full py-3 mt-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 text-xs font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                            <span class="material-icons-round text-sm">add</span> –î–æ–¥–∞—Ç–∏ —â–µ –æ–¥–Ω—É –ø–æ—Å–ª—É–≥—É
                        </button>
                    </div>
                </div>
                <div class="pt-4 border-t border-slate-100 flex gap-3 shrink-0 mb-safe-area">
                    <button onclick="saveService()" class="flex-1 bg-brand text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">–ó–ë–ï–†–ï–ì–¢–ò –í–°–ï</button>
                    ${!isNew ? `<button onclick="deleteService()" class="px-4 text-red-500 bg-red-50 rounded-xl border border-red-100 hover:bg-red-100 transition"><span class="material-icons-round">delete</span></button>` : ''}
                </div>
            `;
            
            // Render items
            const listContainer = document.getElementById('srv-items-list');
            (data.items || []).forEach(item => {
                listContainer.appendChild(createItemRow(item.name, item.price, item.desc));
            });
            // Add empty row if new
            if(isNew) listContainer.appendChild(createItemRow());

            document.getElementById('service-editor-modal').classList.remove('hidden');
        };

        function createItemRow(name='', price='', desc='') {
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-2 relative group hover:border-sky-200 transition-colors";
            div.innerHTML = `
                <div class="flex gap-2">
                    <input type="text" class="item-name w-2/3 bg-white p-2 rounded-lg text-sm font-bold border border-slate-200 outline-none focus:border-sky-400 placeholder:font-normal" placeholder="–ù–∞–∑–≤–∞ –ø–æ—Å–ª—É–≥–∏" value="${name}">
                    <input type="text" class="item-price w-1/3 bg-white p-2 rounded-lg text-sm text-right border border-slate-200 outline-none focus:border-sky-400 font-mono font-bold" placeholder="–¶—ñ–Ω–∞" value="${price}">
                </div>
                <input type="text" class="item-desc w-full bg-white p-2 rounded-lg text-xs text-slate-500 border border-slate-200 outline-none focus:border-sky-400" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" value="${desc}">
                <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full w-6 h-6 flex items-center justify-center shadow-sm hover:bg-red-200 transition"><span class="material-icons-round text-sm">close</span></button>
            `;
            return div;
        }

        window.addServiceItemInput = () => {
            document.getElementById('srv-items-list').appendChild(createItemRow());
        };

        window.saveService = async () => {
            const title = document.getElementById('srv-title').value;
            const icon = document.getElementById('srv-icon').value;
            if(!title) return alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó');

            const items = [];
            document.querySelectorAll('#srv-items-list > div').forEach(div => {
                const name = div.querySelector('.item-name').value;
                if(name) { // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –Ω–∞–∑–≤–∞
                    items.push({
                        name: name,
                        price: div.querySelector('.item-price').value,
                        desc: div.querySelector('.item-desc').value
                    });
                }
            });

            if (currentServiceId) {
                await setDoc(doc(db, "services", currentServiceId), { title, icon, items });
            } else {
                await addDoc(collection(db, "services"), { title, icon, items });
            }
            document.getElementById('service-editor-modal').classList.add('hidden');
        };

        window.deleteService = async () => {
            if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —ñ –≤—Å—ñ –ø–æ—Å–ª—É–≥–∏ –≤ –Ω—ñ–π?')) {
                await deleteDoc(doc(db, "services", currentServiceId));
                document.getElementById('service-editor-modal').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
