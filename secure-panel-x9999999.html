<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HappyFoot Admin</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc"> 
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- COLORS --- */
        .bg-brand { background-color: #04273b; }
        .text-brand { color: #04273b; }

        /* --- ANIMATIONS --- */
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- LAYOUT UTILS --- */
        /* Відступ 1.5 см (прибл. 60px) */
        .tg-safe-top { padding-top: 60px; } 
        .pb-safe-nav { padding-bottom: 100px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, select { -webkit-appearance: none; appearance: none; }
    </style>

    <!-- FIREBASE COMPAT (STABLE) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="text-slate-800 flex flex-col h-full">

    <!-- === 1. LOGIN SCREEN === -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-brand flex flex-col items-center justify-center p-6 text-white transition-opacity duration-500">
        <div class="flex flex-col items-center w-full max-w-xs">
            <div class="text-5xl font-extrabold mb-2 tracking-tight">Happy<span class="text-sky-400">Foot</span></div>
            <div class="text-[10px] opacity-50 tracking-[0.4em] uppercase font-bold mb-10">Admin Panel</div>
            
            <input type="password" id="pin-input" placeholder="PIN" maxlength="4" inputmode="numeric"
                   class="w-full bg-white/10 text-white text-center text-3xl tracking-[0.5em] p-4 rounded-2xl border border-white/10 mb-6 focus:border-sky-400 outline-none transition-all placeholder-white/20">
            
            <button onclick="checkPin()" class="w-full bg-white text-brand font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition-transform">УВІЙТИ</button>
            <p id="login-error" class="text-red-400 text-sm mt-4 hidden font-bold">Невірний PIN</p>
        </div>
    </div>

    <!-- === 2. MAIN APP === -->
    <div id="app-container" class="flex flex-col h-full hidden">
        
        <!-- HEADER -->
        <header class="bg-[#f8fafc] px-5 pb-4 tg-safe-top flex justify-between items-end z-20 shrink-0 select-none border-b border-slate-200/50">
            <div>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1" id="current-date">Завантаження...</p>
                <h1 class="font-bold text-2xl text-brand leading-none">Панель керування</h1>
            </div>
            <button onclick="location.reload()" class="w-10 h-10 rounded-full bg-white shadow-sm border border-slate-100 flex items-center justify-center text-slate-400 active:scale-90 transition">
                <span class="material-icons-round">refresh</span>
            </button>
        </header>

        <!-- CONTENT -->
        <main class="flex-1 overflow-y-auto px-4 pt-4 pb-safe-nav hide-scroll relative w-full max-w-md mx-auto">
            
            <!-- TAB 1: ЗАПИСИ -->
            <div id="tab-active" class="tab-content active space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-slate-700">Всі записи</h2>
                    <span class="text-xs bg-brand text-white px-2 py-1 rounded-md font-bold" id="appt-count">0</span>
                </div>
                <div id="list-active" class="space-y-3 pb-4"></div>
            </div>

            <!-- TAB 2: КОМАНДА -->
            <div id="tab-team" class="tab-content space-y-4">
                <h2 class="text-lg font-bold text-slate-700 px-1">Команда</h2>
                <div id="team-list" class="space-y-3"></div>
                <button onclick="openTeamModal()" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold text-sm flex items-center justify-center gap-2 hover:bg-white active:scale-[0.98] transition">
                    <span class="material-icons-round">add</span> ДОДАТИ ПРАЦІВНИКА
                </button>
            </div>

            <!-- TAB 3: ПОСЛУГИ -->
            <div id="tab-services" class="tab-content space-y-4">
                <h2 class="text-lg font-bold text-slate-700 px-1">Каталог послуг</h2>
                <div id="services-list" class="space-y-3"></div>
                <button onclick="openServiceModal('new-category')" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold text-sm flex items-center justify-center gap-2 hover:bg-white active:scale-[0.98] transition">
                    <span class="material-icons-round">library_add</span> СТВОРИТИ КАТЕГОРІЮ
                </button>
            </div>
        </main>

        <!-- NAV BAR -->
        <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-200 pb-6 pt-3 px-6 flex justify-around items-center z-30 shadow-lg">
            <button onclick="switchTab('active')" id="btn-tab-active" class="nav-btn flex flex-col items-center gap-1 group w-16">
                <span class="material-icons-round text-2xl text-brand p-1 bg-sky-50 rounded-xl transition-all shadow-sm">calendar_today</span>
                <span class="text-[10px] font-bold text-brand">Записи</span>
            </button>
            <button onclick="switchTab('team')" id="btn-tab-team" class="nav-btn flex flex-col items-center gap-1 group w-16 opacity-50">
                <span class="material-icons-round text-2xl text-slate-500 p-1">groups</span>
                <span class="text-[10px] font-bold text-slate-500">Команда</span>
            </button>
            <button onclick="switchTab('services')" id="btn-tab-services" class="nav-btn flex flex-col items-center gap-1 group w-16 opacity-50">
                <span class="material-icons-round text-2xl text-slate-500 p-1">format_list_bulleted</span>
                <span class="text-[10px] font-bold text-slate-500">Послуги</span>
            </button>
        </div>
    </div>

    <!-- === MODALS === -->

    <!-- APPOINTMENT MODAL -->
    <div id="appt-modal" class="fixed inset-0 z-50 hidden flex items-end justify-center sm:items-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeApptModal()"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 shadow-2xl modal-enter relative z-10 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-brand" id="modal-client-name">...</h3>
                    <a id="modal-client-phone-link" href="#" class="text-sky-600 font-bold text-lg flex items-center gap-1 mt-1">
                        <span class="material-icons-round text-sm">call</span> <span id="modal-client-phone">...</span>
                    </a>
                </div>
                <button onclick="closeApptModal()" class="p-2 bg-slate-100 rounded-full text-slate-500"><span class="material-icons-round">close</span></button>
            </div>
            
            <div class="space-y-4">
                <input type="hidden" id="edit-appt-id">
                
                <div class="bg-slate-50 p-3 rounded-xl">
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Дата та Час</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <input type="date" id="edit-date" class="bg-white p-3 rounded-lg font-bold text-brand w-full shadow-sm">
                        <input type="time" id="edit-time" class="bg-white p-3 rounded-lg font-bold text-brand w-full shadow-sm">
                    </div>
                </div>

                <div class="bg-slate-50 p-3 rounded-xl">
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Майстер</label>
                    <select id="edit-specialist" class="w-full mt-1 bg-white p-3 rounded-lg font-bold text-brand shadow-sm">
                        <option value="">Без майстра</option>
                    </select>
                </div>

                <div class="bg-slate-50 p-3 rounded-xl">
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Послуга</label>
                    <div id="display-service" class="font-bold text-brand text-lg px-1">...</div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button id="btn-confirm-appt" onclick="confirmAppointment()" class="col-span-2 bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 flex justify-center items-center gap-2">
                        <span class="material-icons-round">check</span> ПІДТВЕРДИТИ
                    </button>
                    <button onclick="saveAppointmentChanges()" class="bg-brand text-white py-3 rounded-xl font-bold shadow-lg">ЗБЕРЕГТИ</button>
                    <button onclick="deleteAppointment()" class="bg-red-50 text-red-500 py-3 rounded-xl font-bold">ВИДАЛИТИ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TEAM MODAL -->
    <div id="team-modal" class="fixed inset-0 z-50 hidden flex items-end justify-center sm:items-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="document.getElementById('team-modal').classList.add('hidden')"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 shadow-2xl modal-enter relative z-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-brand">Працівник</h3>
                <button onclick="document.getElementById('team-modal').classList.add('hidden')" class="p-2 bg-slate-100 rounded-full text-slate-500"><span class="material-icons-round">close</span></button>
            </div>
            <div class="space-y-3">
                <input type="hidden" id="team-id">
                <input type="text" id="team-name" placeholder="Ім'я (Ольга)" class="w-full bg-slate-50 p-3 rounded-xl font-bold">
                <input type="text" id="team-role" placeholder="Посада (Подолог)" class="w-full bg-slate-50 p-3 rounded-xl">
                
                <div class="border-t border-slate-100 pt-2">
                    <label class="text-xs font-bold text-slate-400 block mb-2 text-center">РОБОЧІ ГОДИНИ</label>
                    <div class="grid grid-cols-4 gap-2" id="team-hours-grid"></div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="saveTeamMember()" class="flex-1 bg-brand text-white py-3 rounded-xl font-bold shadow-lg">ЗБЕРЕГТИ</button>
                    <button onclick="deleteTeamMember()" id="btn-delete-team" class="w-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center"><span class="material-icons-round">delete</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- SERVICE MODAL -->
    <div id="service-modal" class="fixed inset-0 z-50 hidden flex items-end justify-center sm:items-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="document.getElementById('service-modal').classList.add('hidden')"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 shadow-2xl modal-enter relative z-10 h-[80vh] flex flex-col">
            <div id="service-modal-content" class="flex flex-col h-full"></div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC (COMPATIBLE MODE) -->
    <script>
        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBzjaoG4jyD1pjBH9Z0XhL6ZzAp_WT4Ep4",
            authDomain: "happyfoot-lviv.firebaseapp.com",
            projectId: "happyfoot-lviv",
            storageBucket: "happyfoot-lviv.firebasestorage.app",
            messagingSenderId: "825936740538",
            appId: "1:825936740538:web:7aa5fa34a1a5f020f04283"
        };

        // 2. INIT
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (e) {
            alert("Помилка ініціалізації Firebase: " + e.message);
        }

        const db = firebase.firestore(); // Global DB reference

        // 3. STATE
        let specialists = [];
        let appointments = [];
        let services = {};

        // 4. FUNCTIONS
        
        function checkPin() {
            const pin = document.getElementById('pin-input').value;
            if(pin === '1111') {
                document.getElementById('login-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-screen').remove();
                    document.getElementById('app-container').classList.remove('hidden');
                    initApp();
                }, 500);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('pin-input').value = '';
            }
        }

        function initApp() {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('uk-UA', { weekday:'long', day:'numeric', month:'long' });
            setupSpecialists();
            setupAppointments();
            setupServices();
            renderHoursGrid();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Reset Nav Styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.style.opacity = '0.5';
                btn.querySelector('span.material-icons-round').classList.remove('text-brand', 'bg-sky-50', 'shadow-sm');
                btn.querySelector('span.material-icons-round').classList.add('text-slate-500');
            });
            
            // Active Nav Style
            const activeBtn = document.getElementById('btn-tab-' + tabName);
            activeBtn.style.opacity = '1';
            const icon = activeBtn.querySelector('span.material-icons-round');
            icon.classList.remove('text-slate-500');
            icon.classList.add('text-brand', 'bg-sky-50', 'shadow-sm');
        }

        /* === APPOINTMENTS === */
        function setupAppointments() {
            db.collection("appointments").orderBy("date", "asc").onSnapshot((snapshot) => {
                appointments = [];
                snapshot.forEach(doc => appointments.push({id: doc.id, ...doc.data()}));
                
                // Sort by time
                appointments.sort((a,b) => {
                    if(a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.time.localeCompare(b.time);
                });

                renderAppointmentsList();
            }, (error) => {
                console.error("Error getting appointments:", error);
            });
        }

        function renderAppointmentsList() {
            const list = document.getElementById('list-active');
            list.innerHTML = '';
            document.getElementById('appt-count').innerText = appointments.length;

            let lastDate = '';
            appointments.forEach(appt => {
                if(appt.date !== lastDate) {
                    const header = document.createElement('div');
                    header.className = "sticky top-0 bg-[#f8fafc]/95 z-10 py-2 text-xs font-bold text-slate-400 uppercase border-b border-slate-100";
                    header.innerText = appt.date; // Simplified date
                    list.appendChild(header);
                    lastDate = appt.date;
                }

                const isConfirmed = appt.status === 'confirmed';
                const div = document.createElement('div');
                div.className = `bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-4 items-center cursor-pointer ${isConfirmed ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-sky-500'}`;
                div.onclick = () => openApptModal(appt.id);
                div.innerHTML = `
                    <div class="font-bold text-xl text-slate-800">${appt.time}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="font-bold text-slate-800 truncate">${appt.name}</div>
                        <div class="text-xs text-slate-500 truncate">${appt.serviceName}</div>
                        <div class="text-xs text-slate-400 mt-1 flex items-center gap-1">
                            <span class="material-icons-round text-[12px]">person</span> ${appt.specialistName || 'Без майстра'}
                        </div>
                    </div>
                    ${!isConfirmed ? '<span class="w-2 h-2 rounded-full bg-sky-500 animate-pulse"></span>' : ''}
                `;
                list.appendChild(div);
            });
        }

        function openApptModal(id) {
            const appt = appointments.find(a => a.id === id);
            if(!appt) return;

            document.getElementById('edit-appt-id').value = id;
            document.getElementById('modal-client-name').innerText = appt.name;
            document.getElementById('modal-client-phone').innerText = appt.phone;
            document.getElementById('modal-client-phone-link').href = `tel:${appt.phone}`;
            document.getElementById('display-service').innerText = appt.serviceName;
            document.getElementById('edit-date').value = appt.date;
            document.getElementById('edit-time').value = appt.time;

            const select = document.getElementById('edit-specialist');
            select.innerHTML = '<option value="">-- Без майстра --</option>';
            specialists.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.innerText = s.name;
                if(appt.specialistId === s.id) opt.selected = true;
                select.appendChild(opt);
            });

            // Show confirm button only if not confirmed
            const btnConfirm = document.getElementById('btn-confirm-appt');
            if(appt.status === 'confirmed') btnConfirm.classList.add('hidden');
            else btnConfirm.classList.remove('hidden');

            document.getElementById('appt-modal').classList.remove('hidden');
        }

        function closeApptModal() { document.getElementById('appt-modal').classList.add('hidden'); }

        function saveAppointmentChanges() {
            const id = document.getElementById('edit-appt-id').value;
            const newDate = document.getElementById('edit-date').value;
            const newTime = document.getElementById('edit-time').value;
            const specId = document.getElementById('edit-specialist').value;
            
            let specName = 'Будь-хто';
            if(specId) {
                const s = specialists.find(x => x.id === specId);
                if(s) specName = s.name;
            }

            db.collection("appointments").doc(id).update({
                date: newDate,
                time: newTime,
                specialistId: specId || null,
                specialistName: specName
            }).then(() => closeApptModal());
        }

        function confirmAppointment() {
            const id = document.getElementById('edit-appt-id').value;
            db.collection("appointments").doc(id).update({ status: 'confirmed' })
              .then(() => closeApptModal());
        }

        function deleteAppointment() {
            if(confirm("Видалити запис?")) {
                const id = document.getElementById('edit-appt-id').value;
                db.collection("appointments").doc(id).delete()
                  .then(() => closeApptModal());
            }
        }

        /* === TEAM === */
        function setupSpecialists() {
            db.collection("specialists").onSnapshot((snap) => {
                specialists = [];
                const list = document.getElementById('team-list');
                list.innerHTML = '';
                
                snap.forEach(d => {
                    const data = d.data();
                    specialists.push({id: d.id, ...data});
                    
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm";
                    div.onclick = () => editTeam(d.id);
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-brand">${data.name[0]}</div>
                            <div>
                                <div class="font-bold text-slate-800">${data.name}</div>
                                <div class="text-xs text-slate-500">${data.role}</div>
                            </div>
                        </div>
                        <span class="material-icons-round text-slate-300">edit</span>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function renderHoursGrid() {
            const grid = document.getElementById('team-hours-grid');
            grid.innerHTML = '';
            ["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00"].forEach(h => {
                const label = document.createElement('label');
                label.className = "cursor-pointer";
                label.innerHTML = `
                    <input type="checkbox" value="${h}" class="peer hidden">
                    <div class="h-9 flex items-center justify-center rounded-lg border border-slate-200 text-xs font-bold text-slate-400 peer-checked:bg-brand peer-checked:text-white peer-checked:border-brand transition bg-white">${h}</div>
                `;
                grid.appendChild(label);
            });
        }

        function openTeamModal() {
            document.getElementById('team-id').value = '';
            document.getElementById('team-name').value = '';
            document.getElementById('team-role').value = '';
            document.querySelectorAll('#team-hours-grid input').forEach(i => i.checked = true);
            document.getElementById('btn-delete-team').classList.add('hidden');
            document.getElementById('team-modal').classList.remove('hidden');
        }

        function editTeam(id) {
            const spec = specialists.find(s => s.id === id);
            document.getElementById('team-id').value = id;
            document.getElementById('team-name').value = spec.name;
            document.getElementById('team-role').value = spec.role;
            document.querySelectorAll('#team-hours-grid input').forEach(i => {
                i.checked = (spec.hours || []).includes(i.value);
            });
            document.getElementById('btn-delete-team').classList.remove('hidden');
            document.getElementById('team-modal').classList.remove('hidden');
        }

        function saveTeamMember() {
            const id = document.getElementById('team-id').value;
            const name = document.getElementById('team-name').value;
            const role = document.getElementById('team-role').value;
            const hours = Array.from(document.querySelectorAll('#team-hours-grid input:checked')).map(i => i.value);

            if(!name) return alert("Введіть ім'я");

            if(id) {
                db.collection("specialists").doc(id).update({ name, role, hours });
            } else {
                db.collection("specialists").add({ name, role, hours });
            }
            document.getElementById('team-modal').classList.add('hidden');
        }

        function deleteTeamMember() {
            if(confirm("Видалити?")) {
                db.collection("specialists").doc(document.getElementById('team-id').value).delete();
                document.getElementById('team-modal').classList.add('hidden');
            }
        }

        /* === SERVICES === */
        function setupServices() {
            db.collection("services").onSnapshot((snap) => {
                services = {};
                const list = document.getElementById('services-list');
                list.innerHTML = '';
                
                snap.forEach(d => {
                    const data = d.data();
                    services[d.id] = data;
                    
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm mb-3";
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                                <span>${data.icon || '✨'}</span> ${data.title}
                            </h3>
                            <button onclick="openServiceModal('${d.id}')" class="text-xs font-bold text-sky-600 bg-sky-50 px-3 py-1.5 rounded-lg">РЕД.</button>
                        </div>
                        <div class="space-y-1">
                            ${(data.items||[]).map(i => `
                                <div class="flex justify-between text-sm border-b border-slate-50 last:border-0 pb-1">
                                    <span>${i.name}</span>
                                    <span class="font-bold text-brand">${i.price}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        let currentServiceId = null;
        function openServiceModal(id) {
            currentServiceId = (id === 'new-category') ? null : id;
            const data = currentServiceId ? services[id] : { title: '', icon: '', items: [] };

            const html = `
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="text-xl font-bold text-brand">${currentServiceId ? 'Редагування' : 'Створення'}</h3>
                    <button onclick="document.getElementById('service-modal').classList.add('hidden')" class="p-2 bg-slate-100 rounded-full text-slate-500"><span class="material-icons-round">close</span></button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3">
                    <div class="flex gap-2">
                        <input type="text" id="srv-title" value="${data.title}" placeholder="Назва (Манікюр)" class="flex-1 bg-slate-50 p-3 rounded-xl font-bold">
                        <input type="text" id="srv-icon" value="${data.icon}" placeholder="Icon" class="w-16 bg-slate-50 p-3 rounded-xl text-center">
                    </div>
                    <div id="srv-items-list" class="space-y-2"></div>
                    <button onclick="addServiceRow()" class="w-full py-3 border border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-xs">+ ПОЗИЦІЯ</button>
                </div>
                <div class="pt-3 flex gap-2">
                    <button onclick="saveService()" class="flex-1 bg-brand text-white py-3 rounded-xl font-bold shadow-lg">ЗБЕРЕГТИ</button>
                    ${currentServiceId ? '<button onclick="deleteService()" class="w-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center"><span class="material-icons-round">delete</span></button>' : ''}
                </div>
            `;
            document.getElementById('service-modal-content').innerHTML = html;
            
            // Add items
            const list = document.getElementById('srv-items-list');
            if(data.items.length === 0) addServiceRow(list);
            else data.items.forEach(i => addServiceRow(list, i));
            
            document.getElementById('service-modal').classList.remove('hidden');
        }

        function addServiceRow(target, item = {name:'', price:'', desc:''}) {
            const list = target || document.getElementById('srv-items-list');
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-2 rounded-xl border border-slate-100 relative group";
            div.innerHTML = `
                <div class="flex gap-2 mb-2">
                    <input type="text" class="item-name w-2/3 p-2 rounded-lg text-sm font-bold placeholder-slate-400" placeholder="Назва" value="${item.name}">
                    <input type="text" class="item-price w-1/3 p-2 rounded-lg text-sm text-right font-bold text-brand placeholder-slate-400" placeholder="Ціна" value="${item.price}">
                </div>
                <input type="text" class="item-desc w-full p-2 rounded-lg text-xs text-slate-500 placeholder-slate-400 bg-white/50" placeholder="Опис" value="${item.desc}">
                <button onclick="this.parentElement.remove()" class="absolute -top-1 -right-1 bg-white text-red-500 rounded-full w-5 h-5 shadow flex items-center justify-center text-xs">✕</button>
            `;
            list.appendChild(div);
        }

        function saveService() {
            const title = document.getElementById('srv-title').value;
            const icon = document.getElementById('srv-icon').value;
            const items = [];
            document.querySelectorAll('#srv-items-list > div').forEach(div => {
                const name = div.querySelector('.item-name').value;
                if(name) items.push({
                    name, 
                    price: div.querySelector('.item-price').value,
                    desc: div.querySelector('.item-desc').value
                });
            });

            if(!title) return alert("Введіть назву");

            const payload = { title, icon, items };
            if(currentServiceId) db.collection("services").doc(currentServiceId).update(payload);
            else db.collection("services").add(payload);
            
            document.getElementById('service-modal').classList.add('hidden');
        }

        function deleteService() {
            if(confirm("Видалити категорію?")) {
                db.collection("services").doc(currentServiceId).delete();
                document.getElementById('service-modal').classList.add('hidden');
            }
        }

    </script>
</body>
</html>
