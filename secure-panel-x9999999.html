<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HappyFoot Admin</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#04273b"> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Colors */
        .bg-brand { background-color: #04273b; }
        .text-brand { color: #04273b; }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Tabs Animation */
        .tab-content { display: none; animation: fadeIn 0.2s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal Animation */
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .safe-bottom { padding-bottom: 100px; }

        /* Accordion Transition */
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; overflow: hidden; opacity: 0; }
        .accordion-content.open { max-height: 1000px; opacity: 1; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- === 1. LOGIN SCREEN === -->
    <div id="login-screen" class="screen active h-full bg-brand flex flex-col items-center justify-center p-6 text-white relative z-50">
        <div class="flex flex-col items-center w-full max-w-sm">
            <div class="mb-12 text-center">
                <div class="text-5xl font-extrabold mb-2 tracking-tight">Happy<span class="text-sky-400">Foot</span></div>
                <div class="text-[10px] opacity-50 tracking-[0.5em] uppercase font-bold">Admin Control</div>
            </div>
            <div class="w-full bg-white/5 backdrop-blur-xl p-8 rounded-3xl border border-white/10 shadow-2xl">
                <p class="text-center text-sky-100/60 text-xs font-bold uppercase mb-4 tracking-widest">–í–≤–µ–¥—ñ—Ç—å PIN</p>
                <input type="password" id="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric"
                       class="w-full bg-slate-900/50 text-white text-center text-4xl tracking-[0.5em] p-4 rounded-2xl border border-white/10 mb-6 focus:border-sky-400 focus:ring-4 outline-none transition-all">
                <button onclick="checkPin()" class="w-full bg-white text-brand font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">–£–í–Ü–ô–¢–ò</button>
            </div>
        </div>
    </div>

    <!-- === 2. DASHBOARD === -->
    <div id="dashboard-screen" class="screen h-full flex flex-col relative bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white px-5 py-4 shadow-sm flex justify-between items-center z-20 border-b border-slate-100 shrink-0">
            <div>
                <h1 class="font-bold text-xl text-brand flex items-center gap-2">HappyFoot <span class="w-2 h-2 rounded-full bg-green-500"></span></h1>
                <p class="text-xs text-slate-400 font-medium" id="current-date">...</p>
            </div>
            <button onclick="location.reload()" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-red-500 transition">
                <span class="material-icons-round" style="font-size: 20px;">logout</span>
            </button>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto p-4 safe-bottom scroll-smooth bg-[#f8fafc] w-full relative">
            
            <!-- TAB 1: SCHEDULE -->
            <div id="tab-active" class="tab-content active space-y-3">
                <div id="list-active" class="space-y-3 w-full"></div>
            </div>

            <!-- TAB 2: SERVICES EDIT -->
            <div id="tab-services" class="tab-content space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h2 class="text-lg font-bold text-brand">–†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ—Å–ª—É–≥</h2>
                    <button onclick="askResetServices()" class="text-[10px] font-bold text-sky-600 bg-sky-50 px-3 py-1.5 rounded-lg border border-sky-100 hover:bg-sky-100 transition">‚Ü∫ –í–Ü–î–ù–û–í–ò–¢–ò –°–¢–ê–ù–î–ê–†–¢–ù–Ü</button>
                </div>
                <div class="text-xs text-slate-400 px-1 mb-2">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –≤–∏—â–µ, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª—É–≥ —É –±–∞–∑—É.</div>
                
                <div id="services-list" class="space-y-3">
                    <div class="text-center py-10 text-slate-400 text-sm">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å–ª—É–≥...</div>
                </div>
                <button onclick="openServiceModal('new-category')" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-sm flex items-center justify-center gap-2 hover:bg-slate-50 hover:border-slate-400 transition">
                    <span class="material-icons-round">add_circle_outline</span> –î–û–î–ê–¢–ò –ö–ê–¢–ï–ì–û–†–Ü–Æ
                </button>
            </div>

            <!-- TAB 3: HISTORY -->
            <div id="tab-history" class="tab-content space-y-3">
                <div id="list-history" class="space-y-3 opacity-70 w-full"></div>
            </div>

        </div>

        <!-- Bottom Navigation -->
        <div class="bg-white/95 backdrop-blur-lg border-t border-slate-200 p-2 flex justify-around items-center pb-safe z-20 fixed bottom-0 w-full shadow-lg">
            <button onclick="switchTab('active')" id="btn-tab-active" class="nav-btn text-brand bg-blue-50/50"><span class="material-icons-round">event_note</span><span class="text-[10px] font-bold mt-1">–†–û–ó–ö–õ–ê–î</span></button>
            <button onclick="switchTab('services')" id="btn-tab-services" class="nav-btn text-slate-400"><span class="material-icons-round">edit_note</span><span class="text-[10px] font-bold mt-1">–ü–û–°–õ–£–ì–ò</span></button>
            <button onclick="switchTab('history')" id="btn-tab-history" class="nav-btn text-slate-400"><span class="material-icons-round">history</span><span class="text-[10px] font-bold mt-1">–Ü–°–¢–û–†–Ü–Ø</span></button>
        </div>
    </div>

    <!-- === APPOINTMENT MODAL === -->
    <div id="details-modal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0" onclick="closeDetails()"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-enter relative z-10">
            <button onclick="closeDetails()" class="absolute top-4 right-4 p-2 bg-slate-50 rounded-full text-slate-400"><span class="material-icons-round">close</span></button>
            
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800" id="modal-name">–Ü–º'—è</h3>
                <a href="#" id="modal-phone-link" class="text-sky-600 font-bold text-lg mt-1 inline-flex items-center gap-1"><span class="material-icons-round">phone</span> <span id="modal-phone">...</span></a>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-slate-50 p-4 rounded-2xl text-center"><span class="text-xs text-slate-400 font-bold uppercase">–î–∞—Ç–∞</span><div class="text-lg font-bold text-brand" id="display-date">--.--</div></div>
                <div class="bg-slate-50 p-4 rounded-2xl text-center"><span class="text-xs text-slate-400 font-bold uppercase">–ß–∞—Å</span><div class="text-2xl font-extrabold text-brand" id="display-time">--:--</div></div>
            </div>

            <!-- Edit Block -->
            <div id="edit-form" class="hidden mb-4 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input type="date" id="edit-date" class="bg-white border border-slate-200 rounded-xl p-2 text-sm">
                    <select id="edit-time" class="bg-white border border-slate-200 rounded-xl p-2 text-sm"></select>
                </div>
                <button onclick="saveEdit()" class="w-full bg-brand text-white py-2 rounded-xl text-xs font-bold">–ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–ò</button>
            </div>

            <div class="space-y-2">
                <button onclick="toggleEdit()" class="w-full py-3 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm">–ó–ú–Ü–ù–ò–¢–ò –î–ê–¢–£/–ß–ê–°</button>
                <button id="btn-confirm" onclick="askConfirm()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-green-600/20">–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò</button>
                <button onclick="askDelete()" class="w-full text-red-400 py-2 text-xs font-bold">–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å</button>
            </div>
            <input type="hidden" id="current-id">
        </div>
    </div>

    <!-- === SERVICE EDITOR MODAL === -->
    <div id="service-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0" onclick="closeServiceModal()"></div>
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-enter relative z-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-brand" id="service-modal-title">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
                <button onclick="closeServiceModal()" class="p-1 bg-slate-100 rounded-full text-slate-400"><span class="material-icons-round">close</span></button>
            </div>
            
            <div class="space-y-3">
                <!-- Inputs for Service Item -->
                <div id="service-item-inputs" class="hidden space-y-3">
                    <input type="text" id="inp-serv-name" placeholder="–ù–∞–∑–≤–∞ –ø–æ—Å–ª—É–≥–∏" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold">
                    <textarea id="inp-serv-desc" placeholder="–û–ø–∏—Å –ø–æ—Å–ª—É–≥–∏" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 text-sm"></textarea>
                    <input type="text" id="inp-serv-price" placeholder="–¶—ñ–Ω–∞ (–Ω–∞–ø—Ä. 500 ‚Ç¥)" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500">
                </div>
                <!-- Inputs for Category -->
                <div id="service-cat-inputs" class="hidden space-y-3">
                     <input type="text" id="inp-cat-title" placeholder="–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold">
                     <div class="grid grid-cols-4 gap-2" id="icon-picker">
                        <!-- Icons injected by JS -->
                     </div>
                     <input type="hidden" id="inp-cat-icon">
                </div>
                
                <button onclick="saveServiceData()" class="w-full bg-brand text-white py-4 rounded-xl font-bold shadow-lg mt-2">–ó–ë–ï–†–ï–ì–¢–ò</button>
                <button id="btn-delete-service" onclick="deleteServiceData()" class="w-full text-red-500 py-2 text-xs font-bold hidden">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, orderBy, query, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzjaoG4jyD1pjBH9Z0XhL6ZzAp_WT4Ep4",
            authDomain: "happyfoot-lviv.firebaseapp.com",
            projectId: "happyfoot-lviv",
            storageBucket: "happyfoot-lviv.firebasestorage.app",
            messagingSenderId: "825936740538",
            appId: "1:825936740538:web:7aa5fa34a1a5f020f04283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let servicesData = {}; 
        let currentEditType = null; // 'item' or 'category'
        let currentEditPath = null; // { catId, itemIndex }

        // --- FULL STANDARD DATA (AS REQUESTED) ---
        const DEFAULT_SERVICES = {
          'podo': { title: '–ü–æ–¥–æ–ª–æ–≥—ñ—è', icon: 'ü¶∂', items: [ 
            { name: '–ë–∞–∑–æ–≤–∏–π –¥–æ–≥–ª—è–¥', desc: '–ê–ø–∞—Ä–∞—Ç–Ω–∏–π –º–µ–¥–∏—á–Ω–∏–π –ø–µ–¥–∏–∫—é—Ä, –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏–π –¥–æ–≥–ª—è–¥ —Ç–∞ —Ä–µ—Ñ–ª–µ–∫—Å–æ–º–∞—Å–∞–∂', price: '1100 ‚Ç¥' }, 
            { name: '–ö–æ—Ä–µ–∫—Ü—ñ—è –≤—Ä–æ—Å–ª–æ–≥–æ –Ω—ñ–≥—Ç—è', desc: '–ë–µ–∑–æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ –∫–æ—Ä–µ–∫—Ü—ñ—è, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Ä—Ç–æ–Ω—ñ–∫—Å—ñ—ó', price: '900 ‚Ç¥' }, 
            { name: '–û–±—Ä–æ–±–∫–∞ –≥—Ä–∏–±–∫–æ–≤–∏—Ö –Ω—ñ–≥—Ç—ñ–≤', desc: '–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ —á–∏—Å—Ç–∫–∞ —Ç–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –ª—ñ–∫—É–≤–∞–Ω–Ω—è', price: '1000 ‚Ç¥' }, 
            { name: '–ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Å—Ç–æ–ø', desc: '–¢—Ä—ñ—â–∏–Ω–∏, –Ω–∞—Ç–æ–ø—Ç–∏—à—ñ, –º–æ–∑–æ–ª—ñ, –¥—ñ–∞–±–µ—Ç–∏—á–Ω–∞ —Å—Ç–æ–ø–∞', price: '800 ‚Ç¥' }, 
            { name: '–í–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è –æ—Ä—Ç–µ–∑—ñ–≤', desc: '–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª—å–Ω—ñ —Å–∏—Å—Ç–µ–º–∏', price: '500 ‚Ç¥' } 
          ]},
          'manicure': { title: '–ú–∞–Ω—ñ–∫—é—Ä', icon: 'üíÖ', items: [ 
            { name: '–ê–ø–∞—Ä–∞—Ç–Ω–∏–π –º–∞–Ω—ñ–∫—é—Ä', desc: '–î–µ–ª—ñ–∫–∞—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∫—É—Ç–∏–∫—É–ª–∏', price: '600 ‚Ç¥' }, 
            { name: '–Ø–ø–æ–Ω—Å—å–∫–∏–π –º–∞–Ω—ñ–∫—é—Ä', desc: '–ì–ª–∏–±–æ–∫–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≥–ª—è–Ω—Ü–µ–≤–∏–π –±–ª–∏—Å–∫', price: '800 ‚Ç¥' }, 
            { name: '–õ—ñ–∫—É–≤–∞–ª—å–Ω–∏–π –º–∞–Ω—ñ–∫—é—Ä', desc: '–í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º –ª–∞–º–∫–æ—Å—Ç—ñ —Ç–∞ —Ä–æ–∑—à–∞—Ä—É–≤–∞–Ω–Ω—è', price: '700 ‚Ç¥' }, 
            { name: 'SPA-–º–∞–Ω—ñ–∫—é—Ä', desc: '–ü–æ–∂–∏–≤–Ω—ñ –º–∞—Å–∫–∏ —Ç–∞ –æ–ª—ñ—ó –¥–ª—è —à–∫—ñ—Ä–∏ —Ä—É–∫', price: '850 ‚Ç¥' } 
          ]},
          'diagnostics': { title: '–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', icon: 'üî¨', items: [ 
            { name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø–æ–¥–æ–ª–æ–≥–∞', desc: '–û–≥–ª—è–¥, –ø–ª–∞–Ω –ª—ñ–∫—É–≤–∞–Ω–Ω—è, –¥–æ—Ä–æ—Å–ª—ñ —Ç–∞ –¥—ñ—Ç–∏', price: '500 ‚Ç¥' }, 
            { name: '–ó–∞–±—ñ—Ä –∞–Ω–∞–ª—ñ–∑—É', desc: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–µ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –Ω–∞ –≥—Ä–∏–±–æ–∫', price: '550 ‚Ç¥' }, 
            { name: '–û–Ω–ª–∞–π–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è', desc: '–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –æ–≥–ª—è–¥ –ø–æ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ', price: '300 ‚Ç¥' } 
          ]},
          'hands': { title: '–î–æ–≥–ª—è–¥', icon: 'ü§≤', items: [ 
            { name: '–ü–∞—Ä–∞—Ñ—ñ–Ω–æ—Ç–µ—Ä–∞–ø—ñ—è', desc: '–ì–ª–∏–±–æ–∫–µ –∑–≤–æ–ª–æ–∂–µ–Ω–Ω—è —à–∫—ñ—Ä–∏', price: '300 ‚Ç¥' }, 
            { name: '–†–µ—Ñ–ª–µ–∫—Å–æ–º–∞—Å–∞–∂', desc: '–¢–æ—á–∫–æ–≤–∏–π –º–∞—Å–∞–∂ —Å—Ç–æ–ø', price: '400 ‚Ç¥' } 
          ]}
        };

        // --- AUTH & INIT ---
        window.checkPin = function() {
            if(document.getElementById('pin-input').value === '1111') {
                document.getElementById('login-screen').remove();
                initApp();
            } else { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π PIN'); document.getElementById('pin-input').value = ''; }
        }

        function initApp() {
            setupAppointments();
            setupServices();
            
            // Setup Time Select
            const timeSelect = document.getElementById('edit-time');
            ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00"].forEach(t => {
                const opt = document.createElement('option'); opt.value = t; opt.text = t; timeSelect.appendChild(opt);
            });
            
            const d = new Date();
            document.getElementById('current-date').innerText = d.toLocaleDateString('uk-UA', {weekday:'long', day:'numeric', month:'long'});
        }

        // --- TAB LOGIC ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = "nav-btn flex flex-col items-center p-2 w-1/3 rounded-xl transition-all text-slate-400 hover:bg-slate-50";
            });
            document.getElementById(`btn-tab-${tabName}`).className = "nav-btn flex flex-col items-center p-2 w-1/3 rounded-xl transition-all text-brand bg-blue-50/50";
        }

        // ==========================================
        // === SERVICES LOGIC (UPDATED) ===
        // ==========================================

        function setupServices() {
            onSnapshot(collection(db, "services"), (snapshot) => {
                const list = document.getElementById('services-list');
                list.innerHTML = '';
                servicesData = {};

                if(snapshot.empty) {
                    list.innerHTML = `<div class="text-center py-8 text-slate-400">–°–ø–∏—Å–æ–∫ –ø–æ—Å–ª—É–≥ –ø–æ—Ä–æ–∂–Ω—ñ–π.<br>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ"</div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const id = docSnap.id;
                    const data = docSnap.data();
                    servicesData[id] = data;

                    // Create Category Card
                    const catEl = document.createElement('div');
                    catEl.className = "bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm";
                    catEl.innerHTML = `
                        <div class="flex items-center justify-between p-4 bg-slate-50 cursor-pointer" onclick="toggleAccordion('${id}')">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${data.icon || 'üì¶'}</span>
                                <span class="font-bold text-brand">${data.title}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); openServiceModal('edit-category', '${id}')" class="p-1.5 text-slate-400 hover:text-sky-500 bg-white rounded-lg border border-slate-200">
                                    <span class="material-icons-round text-sm">edit</span>
                                </button>
                                <span class="material-icons-round text-slate-300 transform transition-transform" id="arrow-${id}">expand_more</span>
                            </div>
                        </div>
                        <div id="acc-${id}" class="accordion-content bg-white">
                            <div class="p-2 space-y-2">
                                ${(data.items || []).map((item, idx) => `
                                    <div class="flex justify-between items-center p-3 rounded-xl border border-slate-100 hover:bg-slate-50 transition">
                                        <div>
                                            <div class="font-bold text-sm text-slate-700">${item.name}</div>
                                            <div class="text-xs text-slate-400">${item.price}</div>
                                        </div>
                                        <button onclick="openServiceModal('edit-item', '${id}', ${idx})" class="text-sky-500 font-bold text-xs bg-sky-50 px-3 py-1.5 rounded-lg">–†–ï–î.</button>
                                    </div>
                                `).join('')}
                                <button onclick="openServiceModal('new-item', '${id}')" class="w-full py-3 text-xs font-bold text-slate-400 border border-dashed border-slate-200 rounded-xl hover:text-brand hover:border-brand transition">
                                    + –î–û–î–ê–¢–ò –ü–û–°–õ–£–ì–£ –í –¶–Æ –ö–ê–¢–ï–ì–û–†–Ü–Æ
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(catEl);
                });
            });
        }

        window.toggleAccordion = function(id) {
            const content = document.getElementById(`acc-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if(content.classList.contains('open')) {
                content.classList.remove('open');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('open');
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        window.askResetServices = async function() {
            if(confirm("–¶–µ –∑–∞–ø–æ–≤–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–∏–º–∏ –ø–æ–≤–Ω–∏–º —Å–ø–∏—Å–∫–æ–º –≤–∞—à–∏—Ö –ø–æ—Å–ª—É–≥. –ü–æ—Ç–æ—á–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥—É—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ñ. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) {
                try {
                    // Loop through DEFAULT_SERVICES and setDoc for each
                    for (const [key, val] of Object.entries(DEFAULT_SERVICES)) {
                        await setDoc(doc(db, "services", key), val);
                    }
                    alert("–£—Å–ø—ñ—à–Ω–æ! –ü–æ—Å–ª—É–≥–∏ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.");
                } catch(e) {
                    alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
                }
            }
        }

        window.openServiceModal = function(type, catId = null, itemIndex = null) {
            currentEditType = type;
            currentEditPath = { catId, itemIndex };
            
            const modal = document.getElementById('service-modal');
            const itemInputs = document.getElementById('service-item-inputs');
            const catInputs = document.getElementById('service-cat-inputs');
            const title = document.getElementById('service-modal-title');
            const btnDel = document.getElementById('btn-delete-service');

            // Reset
            itemInputs.classList.add('hidden');
            catInputs.classList.add('hidden');
            btnDel.classList.add('hidden');

            if(type === 'new-category') {
                title.innerText = "–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è";
                catInputs.classList.remove('hidden');
                document.getElementById('inp-cat-title').value = '';
                renderIconPicker('ü¶∂');
            } else if (type === 'edit-category') {
                title.innerText = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó";
                catInputs.classList.remove('hidden');
                btnDel.classList.remove('hidden');
                const data = servicesData[catId];
                document.getElementById('inp-cat-title').value = data.title;
                renderIconPicker(data.icon);
            } else if (type === 'new-item') {
                title.innerText = "–ù–æ–≤–∞ –ø–æ—Å–ª—É–≥–∞";
                itemInputs.classList.remove('hidden');
                document.getElementById('inp-serv-name').value = '';
                document.getElementById('inp-serv-desc').value = '';
                document.getElementById('inp-serv-price').value = '';
            } else if (type === 'edit-item') {
                title.innerText = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ—Å–ª—É–≥–∏";
                itemInputs.classList.remove('hidden');
                btnDel.classList.remove('hidden');
                const item = servicesData[catId].items[itemIndex];
                document.getElementById('inp-serv-name').value = item.name;
                document.getElementById('inp-serv-desc').value = item.desc;
                document.getElementById('inp-serv-price').value = item.price;
            }

            modal.classList.remove('hidden');
        }

        function renderIconPicker(current) {
            const icons = ['ü¶∂','üíÖ','üî¨','ü§≤','üíÜ','ü©π','‚ú®','üíä'];
            const container = document.getElementById('icon-picker');
            container.innerHTML = '';
            document.getElementById('inp-cat-icon').value = current;
            
            icons.forEach(ic => {
                const btn = document.createElement('div');
                btn.className = `text-2xl p-2 rounded-lg text-center cursor-pointer border ${ic === current ? 'bg-sky-100 border-sky-500' : 'bg-white border-slate-200'}`;
                btn.innerText = ic;
                btn.onclick = () => {
                    document.getElementById('inp-cat-icon').value = ic;
                    renderIconPicker(ic);
                };
                container.appendChild(btn);
            });
        }

        window.closeServiceModal = function() {
            document.getElementById('service-modal').classList.add('hidden');
        }

        window.saveServiceData = async function() {
            try {
                if(currentEditType === 'new-category') {
                    const title = document.getElementById('inp-cat-title').value;
                    const icon = document.getElementById('inp-cat-icon').value;
                    if(!title) return alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É');
                    const newId = 'cat_' + Date.now();
                    await setDoc(doc(db, "services", newId), { title, icon, items: [] });

                } else if (currentEditType === 'edit-category') {
                    const title = document.getElementById('inp-cat-title').value;
                    const icon = document.getElementById('inp-cat-icon').value;
                    await updateDoc(doc(db, "services", currentEditPath.catId), { title, icon });

                } else if (currentEditType === 'new-item') {
                    const name = document.getElementById('inp-serv-name').value;
                    const desc = document.getElementById('inp-serv-desc').value;
                    const price = document.getElementById('inp-serv-price').value;
                    if(!name || !price) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —Ü—ñ–Ω—É');
                    
                    const catData = servicesData[currentEditPath.catId];
                    const newItems = [...(catData.items || []), { name, desc, price }];
                    await updateDoc(doc(db, "services", currentEditPath.catId), { items: newItems });

                } else if (currentEditType === 'edit-item') {
                    const name = document.getElementById('inp-serv-name').value;
                    const desc = document.getElementById('inp-serv-desc').value;
                    const price = document.getElementById('inp-serv-price').value;
                    
                    const catData = servicesData[currentEditPath.catId];
                    const newItems = [...catData.items];
                    newItems[currentEditPath.itemIndex] = { name, desc, price };
                    await updateDoc(doc(db, "services", currentEditPath.catId), { items: newItems });
                }
                closeServiceModal();
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞: " + e.message); }
        }

        window.deleteServiceData = async function() {
            if(!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?")) return;
            try {
                if(currentEditType === 'edit-category') {
                    await deleteDoc(doc(db, "services", currentEditPath.catId));
                } else if (currentEditType === 'edit-item') {
                    const catData = servicesData[currentEditPath.catId];
                    const newItems = catData.items.filter((_, i) => i !== currentEditPath.itemIndex);
                    await updateDoc(doc(db, "services", currentEditPath.catId), { items: newItems });
                }
                closeServiceModal();
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞: " + e.message); }
        }


        // ==========================================
        // === APPOINTMENTS LOGIC (EXISTING) ===
        // ==========================================
        let currentAppointments = [];

        function setupAppointments() {
            const listActive = document.getElementById('list-active');
            const listHistory = document.getElementById('list-history');

            onSnapshot(query(collection(db, "appointments"), orderBy("date", "asc")), (snapshot) => {
                listActive.innerHTML = ''; listHistory.innerHTML = ''; currentAppointments = [];
                const today = new Date().toISOString().split('T')[0];
                let hasActive = false;

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    currentAppointments.push({ id, ...data });

                    const isHistory = data.date < today;
                    if(!isHistory) hasActive = true;
                    
                    const el = document.createElement('div');
                    let statusColor = data.status === 'new' ? 'border-[#04273b]' : (data.status === 'confirmed' ? 'border-green-500' : 'border-slate-300');
                    let statusBadge = data.status === 'new' ? '<span class="bg-sky-100 text-sky-800 text-[10px] px-2 py-0.5 rounded font-bold">–ù–û–í–ò–ô</span>' : (data.status === 'confirmed' ? '<span class="bg-green-100 text-green-800 text-[10px] px-2 py-0.5 rounded font-bold">OK</span>' : '');

                    el.className = `bg-white p-4 rounded-xl shadow-sm border-l-[6px] ${statusColor} mb-2 cursor-pointer active:scale-95 transition-transform flex justify-between items-center`;
                    el.onclick = () => openDetails(id);
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-lg">${data.name[0]}</div>
                            <div>
                                <h4 class="font-bold text-slate-800 leading-none">${data.name}</h4>
                                <div class="text-xs text-slate-500 mt-1 font-mono">üìÖ ${data.date} ‚Ä¢ ${data.time}</div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">${statusBadge}<span class="material-icons-round text-slate-300">chevron_right</span></div>
                    `;

                    (isHistory ? listHistory : listActive).appendChild(el);
                });

                if(!hasActive) listActive.innerHTML = '<div class="text-center text-slate-300 py-10">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤</div>';
            });
        }

        window.openDetails = function(id) {
            const data = currentAppointments.find(a => a.id === id);
            if(!data) return;
            document.getElementById('current-id').value = id;
            document.getElementById('modal-name').innerText = data.name;
            document.getElementById('modal-phone').innerText = data.phone;
            document.getElementById('modal-phone-link').href = `tel:${data.phone}`;
            document.getElementById('display-date').innerText = data.date;
            document.getElementById('display-time').innerText = data.time;
            
            document.getElementById('edit-date').value = data.date;
            document.getElementById('edit-time').value = data.time;
            
            toggleEdit(false);
            
            const btnConfirm = document.getElementById('btn-confirm');
            if(data.status === 'confirmed' || data.date < new Date().toISOString().split('T')[0]) btnConfirm.classList.add('hidden');
            else btnConfirm.classList.remove('hidden');

            document.getElementById('details-modal').classList.remove('hidden');
        }

        window.closeDetails = () => document.getElementById('details-modal').classList.add('hidden');
        
        window.toggleEdit = function(show = true) {
            const form = document.getElementById('edit-form');
            if(show) { form.classList.remove('hidden'); }
            else { form.classList.add('hidden'); }
        }

        window.saveEdit = async function() {
            const id = document.getElementById('current-id').value;
            try {
                await updateDoc(doc(db, "appointments", id), {
                    date: document.getElementById('edit-date').value,
                    time: document.getElementById('edit-time').value
                });
                closeDetails();
            } catch(e) { alert(e.message); }
        }

        window.askConfirm = async function() {
            if(confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–ø–∏—Å?')) {
                await updateDoc(doc(db, "appointments", document.getElementById('current-id').value), { status: 'confirmed' });
                closeDetails();
            }
        }

        window.askDelete = async function() {
            if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞–∑–∞–≤–∂–¥–∏?')) {
                await deleteDoc(doc(db, "appointments", document.getElementById('current-id').value));
                closeDetails();
            }
        }
    </script>
</body>
</html>
