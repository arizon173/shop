<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HappyFoot Admin</title>
    
    <!-- === PWA / FULL SCREEN SETTINGS === -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#04273b"> 
    <!-- DISPLAY MODE (Crucial for fullscreen behavior) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- ======================================= -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Brand Colors */
        .bg-brand { background-color: #04273b; }
        .text-brand { color: #04273b; }
        .border-brand { border-color: #04273b; }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Tabs Animation */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal Animation */
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .safe-bottom { padding-bottom: 100px; }

        /* --- –ê–ù–Ü–ú–ê–¶–Ü–Ø –ì–ê–õ–û–ß–ö–ò (SUCCESS) --- */
        .checkmark-circle { width: 80px; height: 80px; position: relative; display: inline-block; vertical-align: top; }
        .checkmark-circle .background { width: 80px; height: 80px; border-radius: 50%; background: #22c55e; position: absolute; transform: scale(0); animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .checkmark-circle .checkmark { border-radius: 5px; stroke-width: 3; stroke: #fff; stroke-miterlimit: 10; box-shadow: inset 0px 0px 0px #22c55e; margin: 0 auto; position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: 10; }
        .checkmark-circle .check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { transform: scale(1); box-shadow: inset 0px 0px 0px 30px #22c55e; } }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- === 1. LOGIN SCREEN === -->
    <div id="login-screen" class="screen active h-full bg-brand flex flex-col items-center justify-center p-6 text-white relative">
        <div class="z-10 flex flex-col items-center w-full max-w-sm">
            <div class="mb-12 text-center">
                <div class="text-5xl font-extrabold mb-2 tracking-tight">Happy<span class="text-sky-400">Foot</span></div>
                <div class="text-[10px] opacity-50 tracking-[0.5em] uppercase font-bold">Admin Control</div>
            </div>
            
            <div class="w-full bg-white/5 backdrop-blur-xl p-8 rounded-3xl border border-white/10 shadow-2xl">
                <p class="text-center text-sky-100/60 text-xs font-bold uppercase mb-4 tracking-widest">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –¥–æ—Å—Ç—É–ø—É</p>
                <input type="password" id="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric"
                       class="w-full bg-slate-900/50 text-white text-center text-4xl tracking-[0.5em] p-4 rounded-2xl border border-white/10 mb-6 focus:border-sky-400 focus:ring-4 focus:ring-sky-400/20 outline-none transition-all placeholder-white/10">
                
                <button onclick="checkPin()" class="w-full bg-white text-brand font-bold py-4 rounded-2xl active:scale-[0.98] transition-transform shadow-lg hover:bg-sky-50 flex items-center justify-center gap-2">
                    <span class="material-icons-round">login</span> –£–í–Ü–ô–¢–ò
                </button>
            </div>
        </div>
    </div>

    <!-- === 2. DASHBOARD === -->
    <div id="dashboard-screen" class="screen h-full flex flex-col relative bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white px-5 py-4 shadow-sm flex justify-between items-center z-20 border-b border-slate-100 shrink-0">
            <div>
                <h1 class="font-bold text-xl text-brand flex items-center gap-2">
                    HappyFoot
                    <span class="relative flex h-2.5 w-2.5">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-sky-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-sky-500"></span>
                    </span>
                </h1>
                <p class="text-xs text-slate-400 font-medium" id="current-date">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
            <button onclick="askLogout()" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-red-500 transition active:bg-red-50">
                <span class="material-icons-round" style="font-size: 20px;">logout</span>
            </button>
        </header>

        <!-- Main List Area -->
        <div class="flex-1 overflow-y-auto p-4 safe-bottom scroll-smooth bg-[#f8fafc] w-full relative">
            
            <!-- Tab 1: –†–æ–∑–∫–ª–∞–¥ (–°—å–æ–≥–æ–¥–Ω—ñ + –ú–∞–π–±—É—Ç–Ω—î) -->
            <div id="tab-active" class="tab-content active space-y-3">
                <div id="list-active" class="space-y-3 w-full">
                    <div class="flex flex-col items-center justify-center h-64 text-slate-300 animate-pulse">
                        <span class="material-icons-round text-5xl mb-3">cloud_sync</span>
                        <p class="text-sm font-medium">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
                    </div>
                </div>
            </div>

            <!-- Tab 2: –Ü—Å—Ç–æ—Ä—ñ—è (–ú–∏–Ω—É–ª–µ) -->
            <div id="tab-history" class="tab-content space-y-3">
                <div id="list-history" class="space-y-3 opacity-70 w-full">
                    <!-- JS —Å—é–¥–∏ –∑–∞–∫–∏–Ω–µ —Å—Ç–∞—Ä—ñ -->
                </div>
            </div>

        </div>

        <!-- Bottom Navigation (Tabs) -->
        <div class="bg-white/95 backdrop-blur-lg border-t border-slate-200 p-2 flex justify-around items-center pb-safe z-20 fixed bottom-0 w-full shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
            
            <button onclick="switchTab('active')" id="btn-tab-active" class="flex flex-col items-center text-brand p-2 w-1/2 rounded-xl transition-all">
                <span class="material-icons-round text-2xl mb-1">event_note</span>
                <span class="text-[10px] font-bold uppercase tracking-wide">–†–æ–∑–∫–ª–∞–¥</span>
                <span id="badge-new" class="hidden absolute top-3 ml-6 bg-red-500 text-white text-[9px] px-1.5 rounded-full border-2 border-white shadow-sm">0</span>
            </button>
            
            <div class="w-px h-8 bg-slate-200"></div>

            <button onclick="switchTab('history')" id="btn-tab-history" class="flex flex-col items-center text-slate-400 p-2 w-1/2 rounded-xl transition-all hover:bg-slate-50">
                <span class="material-icons-round text-2xl mb-1">history</span>
                <span class="text-[10px] font-bold uppercase tracking-wide">–Ü—Å—Ç–æ—Ä—ñ—è</span>
            </button>

        </div>
    </div>

    <!-- === 3. DETAILS MODAL (–í—ñ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π) === -->
    <div id="details-modal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0" onclick="closeDetails()"></div>

        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-enter relative z-10 max-h-[90vh] overflow-y-auto">
            <button onclick="closeDetails()" class="absolute top-4 right-4 p-2 bg-slate-50 rounded-full text-slate-400 hover:bg-slate-100 transition">
                <span class="material-icons-round">close</span>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-brand text-white rounded-2xl flex items-center justify-center text-2xl font-bold mx-auto mb-3 shadow-lg shadow-blue-900/20" id="modal-avatar">?</div>
                <h3 class="text-2xl font-bold text-slate-800" id="modal-name">–Ü–º'—è</h3>
                <a href="#" id="modal-phone-link" class="text-sky-600 font-semibold text-lg mt-1 inline-flex items-center gap-1 hover:underline">
                    <span class="material-icons-round">phone</span> <span id="modal-phone">...</span>
                </a>
                <div class="mt-3 flex justify-center gap-2" id="modal-status-container">
                    <!-- –°—Ç–∞—Ç—É—Å —Å—é–¥–∏ -->
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col items-center">
                    <span class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">–î–∞—Ç–∞</span>
                    <span class="text-lg font-bold text-brand" id="display-date">--.--</span>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col items-center">
                    <span class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">–ß–∞—Å</span>
                    <span class="text-2xl font-extrabold text-brand" id="display-time">--:--</span>
                </div>
            </div>

            <!-- Edit Form (Hidden by default) -->
            <div id="edit-form" class="hidden mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                <h4 class="text-sm font-bold text-brand mb-3 flex items-center gap-2">
                    <span class="material-icons-round text-sm">edit</span> –ó–º—ñ–Ω–∞ –∑–∞–ø–∏—Å—É
                </h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-500">–ù–æ–≤–∞ –¥–∞—Ç–∞</label>
                        <input type="date" id="edit-date" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none focus:border-sky-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">–ù–æ–≤–∏–π —á–∞—Å</label>
                        <select id="edit-time" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none focus:border-sky-500">
                        </select>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="toggleEdit(false)" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-500 text-xs font-bold">–°–ö–ê–°–£–í–ê–¢–ò</button>
                        <button onclick="saveEdit()" class="flex-1 py-3 rounded-xl bg-brand text-white text-xs font-bold">–ó–ë–ï–†–ï–ì–¢–ò</button>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="space-y-3">
                <button id="btn-edit-toggle" onclick="toggleEdit(true)" class="w-full py-3.5 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                    <span class="material-icons-round text-lg">edit_calendar</span> –ü–ï–†–ï–ù–ï–°–¢–ò / –ó–ú–Ü–ù–ò–¢–ò
                </button>
                
                <button id="btn-confirm" onclick="askConfirm()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-sm shadow-lg shadow-green-600/20 active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <span class="material-icons-round">check_circle</span> –ü–Ü–î–¢–í–ï–†–î–ò–¢–ò
                </button>
                
                <button id="btn-delete" onclick="askDelete()" class="w-full text-red-400 py-2 text-xs font-bold hover:text-red-600 flex items-center justify-center gap-1">
                    <span class="material-icons-round text-sm">delete</span> –í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å
                </button>
            </div>
            
            <input type="hidden" id="current-id">
        </div>
    </div>

    <!-- === 4. CUSTOM ALERT/CONFIRM MODAL (–ù–æ–≤—ñ –≤—ñ–∫–Ω–∞ –∑–∞–º—ñ—Å—Ç—å alert) === -->
    <div id="custom-modal" class="fixed inset-0 bg-slate-900/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl modal-enter text-center">
            
            <!-- Icon Area -->
            <div id="c-icon-container" class="mb-4 flex justify-center"></div>
            
            <h3 id="c-title" class="text-xl font-bold text-brand mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <p id="c-text" class="text-sm text-slate-500 mb-6">–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</p>
            
            <!-- Buttons -->
            <div id="c-buttons" class="flex gap-3 justify-center">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- === 5. SUCCESS ANIMATION OVERLAY === -->
    <div id="success-overlay" class="fixed inset-0 bg-white z-[70] hidden flex flex-col items-center justify-center">
        <div class="checkmark-circle">
            <div class="background"></div>
            <div class="checkmark draw"></div>
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <path class="check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mt-6 fade-in">–£—Å–ø—ñ—à–Ω–æ!</h2>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, orderBy, query, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzjaoG4jyD1pjBH9Z0XhL6ZzAp_WT4Ep4",
            authDomain: "happyfoot-lviv.firebaseapp.com",
            projectId: "happyfoot-lviv",
            storageBucket: "happyfoot-lviv.firebasestorage.app",
            messagingSenderId: "825936740538",
            appId: "1:825936740538:web:7aa5fa34a1a5f020f04283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentAppointments = [];
        const WORK_HOURS = ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00"];
        
        // –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Å–µ–ª–µ–∫—Ç —á–∞—Å—É
        const timeSelect = document.getElementById('edit-time');
        WORK_HOURS.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t; opt.text = t;
            timeSelect.appendChild(opt);
        });

        /* --- CUSTOM MODALS SYSTEM --- */
        function showModal(title, text, type = 'info', onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            const iconCont = document.getElementById('c-icon-container');
            const btns = document.getElementById('c-buttons');
            
            document.getElementById('c-title').innerText = title;
            document.getElementById('c-text').innerText = text;

            if(type === 'danger') {
                iconCont.innerHTML = `<div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-500"><span class="material-icons-round text-3xl">warning</span></div>`;
            } else if (type === 'success') {
                 iconCont.innerHTML = `<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-500"><span class="material-icons-round text-3xl">done</span></div>`;
            } else {
                iconCont.innerHTML = `<div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-brand"><span class="material-icons-round text-3xl">info</span></div>`;
            }

            if (onConfirm) {
                btns.innerHTML = `
                    <button onclick="closeCustomModal()" class="flex-1 py-3 rounded-xl border border-slate-200 text-slate-500 font-bold text-sm">–ù–Ü</button>
                    <button id="modal-confirm-btn" class="flex-1 py-3 rounded-xl ${type === 'danger' ? 'bg-red-500' : 'bg-brand'} text-white font-bold text-sm shadow-lg">–¢–ê–ö</button>
                `;
                document.getElementById('modal-confirm-btn').onclick = () => {
                    closeCustomModal();
                    onConfirm();
                };
            } else {
                btns.innerHTML = `<button onclick="closeCustomModal()" class="flex-1 py-3 rounded-xl bg-brand text-white font-bold text-sm shadow-lg">–ó–†–û–ó–£–ú–Ü–õ–û</button>`;
            }

            modal.classList.remove('hidden');
        }

        window.closeCustomModal = function() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        function playSuccess() {
            const overlay = document.getElementById('success-overlay');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 1800);
        }

        /* --- LOGIC WRAPPERS FOR MODALS --- */

        window.askConfirm = function() {
            showModal('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è', '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–ø–∏—Å —Ç–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∞—Ä—Ö—ñ–≤?', 'info', async () => {
                const id = document.getElementById('current-id').value;
                try {
                    await updateDoc(doc(db, "appointments", id), { status: "confirmed" });
                    closeDetails();
                    playSuccess();
                } catch (e) { showModal('–ü–æ–º–∏–ª–∫–∞', e.message, 'danger'); }
            });
        }

        window.askDelete = function() {
            showModal('–í–∏–¥–∞–ª–µ–Ω–Ω—è', '–¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–æ. –í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å –Ω–∞–∑–∞–≤–∂–¥–∏?', 'danger', async () => {
                const id = document.getElementById('current-id').value;
                try {
                    await deleteDoc(doc(db, "appointments", id));
                    closeDetails();
                    playSuccess();
                } catch (e) { showModal('–ü–æ–º–∏–ª–∫–∞', e.message, 'danger'); }
            });
        }
        
        window.saveEdit = async function() {
            const id = document.getElementById('current-id').value;
            const newDate = document.getElementById('edit-date').value;
            const newTime = document.getElementById('edit-time').value;

            if(!newDate || !newTime) return showModal('–ü–æ–º–∏–ª–∫–∞', '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è –¥–∞—Ç–∏ —Ç–∞ —á–∞—Å—É.', 'danger');

            try {
                await updateDoc(doc(db, "appointments", id), {
                    date: newDate,
                    time: newTime
                });
                closeDetails();
                playSuccess();
            } catch (e) { showModal('–ü–æ–º–∏–ª–∫–∞', e.message, 'danger'); }
        }
        
        window.checkPin = function() {
            if(document.getElementById('pin-input').value === '1111') {
                document.getElementById('login-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-screen').classList.remove('active');
                    document.getElementById('dashboard-screen').classList.add('active');
                    startListening();
                    // Set default tab on success
                    switchTab('active');
                }, 300);
            } else {
                showModal('–ü–æ–º–∏–ª–∫–∞', '–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥. –°–ø—Ä–æ–±—É–π—Ç–µ 1111.', 'danger');
                document.getElementById('pin-input').value = '';
            }
        }
        
        window.logout = function() { showModal('–í–∏—Ö—ñ–¥', '–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?', 'info', () => location.reload()); }


        // --- TABS & RENDERING ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.getElementById('btn-tab-active').className = "flex flex-col items-center text-slate-400 p-2 w-1/2 rounded-xl transition-all hover:bg-slate-50";
            document.getElementById('btn-tab-history').className = "flex flex-col items-center text-slate-400 p-2 w-1/2 rounded-xl transition-all hover:bg-slate-50";
            
            if(tabName === 'active') {
                document.getElementById('btn-tab-active').className = "flex flex-col items-center text-brand p-2 w-1/2 rounded-xl bg-blue-50/50 transition-all";
            } else {
                document.getElementById('btn-tab-history').className = "flex flex-col items-center text-brand p-2 w-1/2 rounded-xl bg-blue-50/50 transition-all";
            }
        }

        function startListening() {
            const listActive = document.getElementById('list-active');
            const listHistory = document.getElementById('list-history');
            const badgeNew = document.getElementById('badge-new');

            const q = query(collection(db, "appointments"), orderBy("date", "asc"));

            onSnapshot(q, (snapshot) => {
                listActive.innerHTML = '';
                listHistory.innerHTML = '';
                currentAppointments = [];
                
                let newCount = 0;
                // –°—å–æ–≥–æ–¥–Ω—ñ—à–Ω—è –¥–∞—Ç–∞ —É —Ñ–æ—Ä–º–∞—Ç—ñ YYYY-MM-DD
                const today = new Date().toISOString().split('T')[0];

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const isNew = data.status === 'new';
                    
                    currentAppointments.push({ id, ...data });

                    if(isNew) newCount++;

                    // LOGIC: History if date is past
                    const isHistory = data.date < today;

                    const card = document.createElement('div');
                    card.onclick = () => openDetails(id);
                    
                    // Card Styling based on status
                    let statusBorder = 'border-l-4 border-slate-300';
                    if(isNew) statusBorder = 'border-l-[6px] border-[#04273b]';
                    else if(data.status === 'confirmed') statusBorder = 'border-l-[6px] border-green-500';

                    card.className = `relative bg-white p-4 rounded-xl shadow-sm ${statusBorder} mb-3 cursor-pointer active:scale-[0.98] transition-transform fade-in`;
                    
                    let statusLabel = '';
                    if(isNew) statusLabel = '<span class="bg-sky-100 text-sky-700 text-[10px] font-bold px-2 py-1 rounded uppercase">–ù–û–í–ò–ô</span>';
                    else if(data.status === 'confirmed') statusLabel = '<span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded uppercase">OK</span>';
                    else statusLabel = '<span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded uppercase">–ê–†–•–Ü–í</span>';


                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${isNew ? 'bg-brand text-white' : 'bg-slate-100 text-slate-400'} flex items-center justify-center font-bold text-lg">
                                    ${data.name ? data.name[0].toUpperCase() : '?'}
                                </div>
                                <div>
                                    <h3 class="font-bold text-base text-slate-800 leading-tight">${data.name}</h3>
                                    <div class="text-xs text-slate-500 font-mono mt-0.5">üìÖ ${data.date} ‚Ä¢ ‚è∞ ${data.time || '--:--'}</div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                ${statusLabel}
                                <span class="material-icons-round text-slate-300 text-lg">chevron_right</span>
                            </div>
                        </div>
                    `;

                    if(isHistory) {
                        listHistory.appendChild(card);
                    } else {
                        listActive.appendChild(card);
                    }
                });

                if(newCount > 0) {
                    badgeNew.innerText = newCount;
                    badgeNew.classList.remove('hidden');
                } else {
                    badgeNew.classList.add('hidden');
                }
                
                if(listActive.innerHTML === '') listActive.innerHTML = '<div class="text-center text-slate-400 mt-10">–ù–∞ —Å—å–æ–≥–æ–¥–Ω—ñ/–∑–∞–≤—Ç—Ä–∞ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î</div>';
                if(listHistory.innerHTML === '') listHistory.innerHTML = '<div class="text-center text-slate-400 mt-10">–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>';
            });
        }

        window.openDetails = function(id) {
            const data = currentAppointments.find(a => a.id === id);
            if(!data) return;

            document.getElementById('current-id').value = id;
            document.getElementById('modal-name').innerText = data.name;
            document.getElementById('modal-phone').innerText = data.phone;
            document.getElementById('modal-phone-link').href = `tel:${data.phone}`;
            document.getElementById('display-date').innerText = data.date || '---';
            document.getElementById('display-time').innerText = data.time || '--:--';
            document.getElementById('modal-avatar').innerText = data.name ? data.name[0].toUpperCase() : '?';

            const btnConfirm = document.getElementById('btn-confirm');
            const btnEditToggle = document.getElementById('btn-edit-toggle');
            const sContainer = document.getElementById('modal-status-container');
            
            const today = new Date().toISOString().split('T')[0];
            const isFinished = data.date < today;

            // Resetting visibility based on business rules
            btnConfirm.classList.add('hidden');
            btnEditToggle.classList.add('hidden');
            
            if (isFinished) {
                 sContainer.innerHTML = '<span class="bg-slate-100 text-slate-500 text-xs font-bold px-3 py-1 rounded-full uppercase">–Ü–°–¢–û–†–Ü–Ø</span>';
            } else if (data.status === 'new') {
                sContainer.innerHTML = '<span class="bg-sky-100 text-sky-700 text-xs font-bold px-3 py-1 rounded-full uppercase">–ù–û–í–ò–ô –ó–ê–ü–ò–°</span>';
                btnConfirm.classList.remove('hidden'); // Show Confirm
                btnEditToggle.classList.remove('hidden'); // Show Edit
            } else if (data.status === 'confirmed') {
                 sContainer.innerHTML = '<span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full uppercase">–ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–û ‚úÖ</span>';
                 btnEditToggle.classList.remove('hidden'); // Show Edit
            }

            toggleEdit(false);
            document.getElementById('details-modal').classList.remove('hidden');
        }

        window.closeDetails = function() {
            document.getElementById('details-modal').classList.add('hidden');
        }

        window.toggleEdit = function(show) {
            const form = document.getElementById('edit-form');
            const display = document.getElementById('btn-edit-toggle');
            const confirmBtn = document.getElementById('btn-confirm');
            
            if(show) {
                form.classList.remove('hidden');
                display.classList.add('hidden');
                confirmBtn.classList.add('hidden');
                
                const id = document.getElementById('current-id').value;
                const data = currentAppointments.find(a => a.id === id);
                if(data) {
                    document.getElementById('edit-date').value = data.date;
                    document.getElementById('edit-time').value = data.time;
                }
            } else {
                form.classList.add('hidden');
                display.classList.remove('hidden');
                const id = document.getElementById('current-id').value;
                const data = currentAppointments.find(a => a.id === id);
                
                // Show confirm button only if status is NEW and not archived
                if(data && data.status === 'new' && data.date >= new Date().toISOString().split('T')[0]) {
                    confirmBtn.classList.remove('hidden');
                }
            }
        }

        window.saveEdit = async function() {
            const id = document.getElementById('current-id').value;
            const newDate = document.getElementById('edit-date').value;
            const newTime = document.getElementById('edit-time').value;

            if(!newDate || !newTime) return showModal('–ü–æ–º–∏–ª–∫–∞', '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è –¥–∞—Ç–∏ —Ç–∞ —á–∞—Å—É.', 'danger');

            try {
                await updateDoc(doc(db, "appointments", id), {
                    date: newDate,
                    time: newTime
                });
                closeDetails();
                playSuccess();
            } catch (e) { showModal('–ü–æ–º–∏–ª–∫–∞', e.message, 'danger'); }
        }

        window.confirmFromModal = async function() {
            const id = document.getElementById('current-id').value;
            if(confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')) {
                try {
                    await updateDoc(doc(db, "appointments", id), { status: "confirmed" });
                    closeDetails();
                    playSuccess();
                } catch (e) { alert(e.message); }
            }
        }

        window.deleteFromModal = async function() {
            const id = document.getElementById('current-id').value;
            if(confirm('–í–ò–î–ê–õ–ò–¢–ò –∑–∞–ø–∏—Å –Ω–∞–∑–∞–≤–∂–¥–∏?')) {
                try {
                    await deleteDoc(doc(db, "appointments", id));
                    closeDetails();
                    playSuccess();
                } catch (e) { alert(e.message); }
            }
        }

        const d = new Date();
        document.getElementById('current-date').innerText = d.toLocaleDateString('uk-UA', {weekday:'long', day:'numeric', month:'long'});
    </script>
</body>
</html>
